# Отладка как наука

# Пример 1

   Проект с курса Яндекса. Система записывает значение метрик на сервер. Метрики сохраняются в мапе, которые позже сериализуются (в моем случае, записывались в файл в виде JSON). 
Если сервер перезапускался с флагом RESTORE, то все данные из файла десериализовались на сервер. Теперь к проблеме.
   После создания новой фичи, одни из автотестов начали падать, говоря, что после записи метрики, при попытке получить ее значение, метрика не найдена (ожидалось 200, а получал 404). Назовем этот случай Т1.
Как я пытался отлаживал данный баг: была гипотеза, что при записи метрики, алгоритм как-то неверно записывал метрику (например, использовал в качестве ключа не имя метрики, а иное поле) из-за чего метрику нельзя было найти.
Данная гипотеза была опровергнута тестами, которые успешно "проходили данных сценарий". Проблема была в том, что сервер возвращал 404 только одном случае при одном сценарии, но этот сценарий успешно обрабатывали тесты, из-за чего я 
начал "гадать" где-же кроется ошибка. Стоит сказать, что автотесты со случаем Т1 проходили до определенного момента, т.е. Т1 мог успешно пройти часть автотестов, а после автотеста А1 падал.
   Попробуем решить данную проблему, задавая не конкретные вопросы (почему вернул именно 404), а широкие. Например, можно задать вопрос не "почему сервер возвращает именно 404", а "автотесты падают в момент, когда была добавлена поддержка флагов (RESTORE)".
Мы откинем все связанное не с флагами, поскольку: 
1) более ранние автотесты подтверджают корректную работу системы
2) добавление флагов -- точка, где автотесты ломаются, и, что важно, при добавлении флагов, логика сервера записи/чтения не менялась.
Теперь, вместо многих конкретных причин, связанных с записью и чтением, нужно проверить, как работает система с включенным и выключенным флагом. В случае, если флаг был выключен, то автотесты проходили, иначе -- падали. 
То есть, при включенном флаге RESTORE данные не появлялись на сервере.

Ошибка заключалась в следующем -- автотесты с включенным флагом "роняли" сервер и проверяли, что ранее записанные данные десериализуются на сервер, и, поскольку я неверно написал логику десериализации, данные не десериализовались на сервер, из-за чего, 
при попытке чтения данных, возвращалась 404. До этого, я потратил несколько часов на поиск ошибки в логие чтения/записи и несколько часов на "гадания", но "откидавая ненужные варианты" я буквально за три вопроса пришел бы к источнику проблемы.
То есть вопросы:
1) С какого момента появилась ошибка?
2) Какие изменения внес момент в систему, когда появилась ошибка?
3) В каком конкретном состоянии находится программа (на 1-ом уровне), при котором ошибка возникает?

привели к источнмку пробенмы.

Пример 2

   Проект с прошлой работы. Сервис рассчитывал финансовые показатели на основе ежедневно обновляемых исходных данных и рассчитанные показатели отражались в tableau. Однажды показатели конкретного сервиса выдавали неверное значение (было сильное расхождение с подтвержденными данными) в некоторые дни месяца.
В остальные дни данные были корректны. Требовалось определить, была ли это ошибка программы или это было просто поведение метода расчета. Забегая вперед, могу сказать, ошибка была выявлена методом "перебора всевозможных вариантов" и ошибка заключалась в коде и 
постановке: иногда приходили данные, которые выходили за инварианты, указанные в постановке (например, один из коэффициентов, который должен был быть в диапазоне от 1 до 10, мог быть 0, отрицательным или многобольше 10), в коде, в случае если приходили невалидные данные, 
подобные коэффициенты и показатели имели некоторый дефолтное значение (вот только проблема, никак не отражалось в БД, что было ли рассчет на основе дефолтных значений, что означает, что исходные данные были невалидны). Ситуацию осложняло, что некоторые данные обновлялись  в БД, а не записывались новые, из-за чего отследить было крайне сложно ошибку. Кстати, следовало бы больше логгировать, поскольку одни и те же данные могли отличаться, подобная избыточность информации очень помогла. Кстати, следовало бы больше логгировать, поскольку одни и те же данные могли отличаться, подобная избыточность информации очень помогла. 
   В общем, как можно было найти проблему в данном случае. Будем говорить об ошибке в тот день, когда итоговые показатели сильно расходились. 
1) На основе каких исходных данных были сделаны рассчеты? В случае, если исходные данные валидны, то ошибка определенно была бы в коде. Изучив все исходные данные для конкретного сервиса, была обнаружена несостыковка между постановкой
и реальными данными. 
2) Как программа работает с невалидными исходными данными? Поскольку я создал АТД, которые принимали дефолтные значению в случае несоответствия пред-условиям, нужно было определить, насколько дефолтные значения влияют на процент расхождения.
По мере бурных обсуждений, проб и проверок, были установлены иные значения, но это еще не все
3) Действительно ли новопринятые изменения не нарушают логику программы, не противоречат первым двум вопросом? Данный вопрос решался методом наблюдения -- просто изучали, как поведет себя метод.
   Через призму времени кажется, что проблема решалась легко. Но я провел несколько дней, ища баг не там где нужно, поскольку не рассмотрел вариант "на основе каких данных делались рассчеты?".



Пример 3


