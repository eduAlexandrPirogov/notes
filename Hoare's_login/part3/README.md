# Логика Хоара для программистов-2 (2)

## Зависимость от более строгого результата, нежели гарантируется спецификацией

### Пример 1

Буквально на днях закрыл свою последнюю задачу на текущий работе, которая хороша показывает ошибку модульного рассуждения.
Дано: имеются сотовые-операторы, которые предоставляют услуги по определенным тарифам. Сами тарифы -- объект, который состоит из 6 таблиц в БД.
Суть задачи заключалась в возможности копирования тарифов, т.е. мы выбираем партнера, выбираем эталонный тариф, выбираем целевых партнеров и копируем целевым партнерам эталонный тариф.

Я реализовал это в виде процедуры:

```sql
create procedure copy_rates_by_template(
	  administrator_id INT,
	  source_ip varchar(120),
    parent_rate_id INT,
    new_date_item DATE,
    target_partners_array VARCHAR(255) <--- имитация массива через строку: "1,2,..."
)
```

То есть имеется веб-приложение, где пользователь заполняет форму и с выбранными аргументами вызывается процедура в БД.
В чем же я допустил ошибку? Рассмотрим созданною мною спецификацию относительно параметра target_partners_array:
Пред-условие: дан массив целеых партнеров в виде строки вида "1,2,...", для которой будут скопированы тарифы.
Пост-условие: для всех целевых партнеров, в случае отсутствия нарушения ограничений на уровне БД, были созданы тарифы на основе данного parent_rate_id.

Если использовать данную процедуру через веб-приложение, где заранее выдаются корректные данные и происходит их верификация, процедура работает безукоризненно. 
Но что если эту процедуру потребуется вызвать руками из БД? 
При тестировании процедуры, я дал ей несуществующие id целевых партнеров. И, к моему удивлению, процедура отработала без исключений -- в таблице тарифов был создан объект
с полем partner_id, значением которого было несуществующий партнер, что нарушало ссылочную целостность.

То есть пост-условие:  для всех целевых партнеров, (!) в случае отсутствия нарушения ограничений на уровне БД (!)... 
Изучив ситуацию, я выяснил, что на поле partner_id отсутствовало ограничение FK из-за чего нарушалась ссылочная целостность. 
С одной стороны можно сказать, что мое пост-условие не нарушается, т.к не стоит ограничение на уровне БД, но если смотреть на эту ситуацию немного уровнем выше
(не уровень реализации, а логический), то в данной реализации результат работы системы в целом зависит от более жесткого результата, нежели гарантируется моей процедурой 
(зачем нам нужны тарифы, у которых нет владельцев?).

По итогу я добавил дополнительную проверку, тем самым сделав спецификацию пост-условия строже.


### Пример 2

## Зависимость от возможности использовать более мягкие реализации, чем гарантирует спецификация

### Пример 1

### Пример 2
